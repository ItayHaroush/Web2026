# ✅ תיקון ניהול קבוצות תוספות - סיכום

## תאריך: 31 בינואר 2026

## 🎯 הבעיה שתוקנה

**בעיה מקורית:**
- כשמשנים שם קבוצה, נוצרת קבוצה חדשה מידית ללא אפשרות הסרה
- אין אפשרות למחוק קבוצות
- אין אפשרות להוסיף קבוצה חדשה דרך הממשק
- אין אישור לפני מחיקת פריטים

## ✨ פתרונות שהוספו

### 1. **הוספת קבוצה חדשה**
- ✅ כפתור + ליד כותרת "קבוצות תוספות"
- ✅ מודאל מעוצב להוספת קבוצה
- ✅ שדות: שם, מינימום, מקסימום, סטטוס
- ✅ API POST `/admin/addon-groups`

### 2. **עריכת קבוצה קיימת**
- ✅ כפתור עריכה (עיפרון כחול) בהובר על קבוצה
- ✅ פותח מודאל עם הנתונים הקיימים
- ✅ שינוי שם לא יוצר קבוצה חדשה אלא מעדכן את הקיימת
- ✅ API PUT `/admin/addon-groups/{id}`

### 3. **מחיקת קבוצה**
- ✅ כפתור מחיקה (פח אדום) בהובר על קבוצה
- ✅ בדיקה אם יש פריטים בקבוצה
- ✅ אישור לפני מחיקה: "האם אתה בטוח שברצונך למחוק את הקבוצה..."
- ✅ אם יש פריטים: הודעה "לא ניתן למחוק קבוצה שיש בה X פריטים"
- ✅ API DELETE `/admin/addon-groups/{id}`

### 4. **מחיקת פריטים (שיפור)**
- ✅ אישור לפני מחיקה
- ✅ הודעת שגיאה אם נכשל

---

## 📁 קבצים ששונו

### Backend

#### 1. `app/Http/Controllers/AdminController.php`

**פונקציה חדשה: `storeAddonGroup()`**
```php
public function storeAddonGroup(Request $request)
{
    // יוצר קבוצת תוספות חדשה
    // validation: name (required), min_selections, max_selections, is_active
    // מחשב sort_order אוטומטי
    // מטפל ב-max_selections = 0 → null (ללא הגבלה)
}
```

**פונקציה חדשה: `deleteAddonGroup()`**
```php
public function deleteAddonGroup(Request $request, $id)
{
    // בודק אם יש פריטים בקבוצה
    // אם יש - מחזיר שגיאה 400
    // אם אין - מוחק את הקבוצה
}
```

#### 2. `routes/api.php`

**Routes חדשים:**
```php
Route::post('/addon-groups', [AdminController::class, 'storeAddonGroup']);
Route::delete('/addon-groups/{id}', [AdminController::class, 'deleteAddonGroup']);
```

---

### Frontend

#### `pages/admin/AdminSalads.jsx`

**States חדשים:**
```javascript
const [groupModalOpen, setGroupModalOpen] = useState(false);
const [editingGroup, setEditingGroup] = useState(null);
const [groupForm, setGroupForm] = useState({
    name: '',
    min_selections: '0',
    max_selections: '',
    is_active: true,
});
```

**פונקציות חדשות:**
- `openGroupModal(group = null)` - פותח מודאל (עריכה או חדש)
- `closeGroupModal()` - סוגר מודאל ומנקה state
- `handleGroupSubmit(event)` - שומר קבוצה (POST/PUT)
- `deleteGroup(groupId)` - מוחק קבוצה עם אישור

**שינויים בממשק:**
1. **Header של קבוצות** - הוספת כפתור +
2. **רשימת קבוצות** - כפתורי עריכה ומחיקה בהובר
3. **מודאל חדש** - טופס להוספה/עריכת קבוצה

---

## 🎨 עיצוב ממשק

### כפתורים בסרגל צד
```jsx
{isManager() && (
    <div className="absolute left-2 top-1/2 -translate-y-1/2 
                    opacity-0 group-hover/item:opacity-100 transition-opacity 
                    flex gap-1 z-10">
        <button /* עריכה - כחול */ >
            <FaEdit />
        </button>
        <button /* מחיקה - אדום */ >
            <FaTrash />
        </button>
    </div>
)}
```

### מודאל קבוצה
- **כותרת דינמית:** "הוספת קבוצה חדשה" / "עריכת קבוצה"
- **שדות:** שם (חובה), מינימום, מקסימום, סטטוס
- **כפתורים:** שמור / ביטול
- **אנימציות:** fade-in, zoom-in

---

## 🔒 אבטחה ו-Validation

### Backend Validation
```php
// יצירה
'name' => 'required|string|max:255',
'min_selections' => 'sometimes|integer|min:0|max:99',
'max_selections' => 'nullable|integer|min:0|max:99',
'is_active' => 'sometimes|boolean',

// מחיקה
- בדיקת מנהל (isManager)
- בדיקת שייכות למסעדה
- בדיקת פריטים בקבוצה
```

### Frontend Validation
- שם קבוצה חובה (required)
- מינימום ≤ מקסימום
- אישור לפני מחיקה

---

## 🧪 תסריט בדיקות

### בדיקה 1: הוספת קבוצה חדשה
1. לחץ על כפתור + ליד "קבוצות תוספות"
2. הזן שם: "תוספות מיוחדות"
3. הגדר min: 1, max: 3
4. שמור
5. ✅ **צפוי:** הקבוצה מופיעה ברשימה

### בדיקה 2: עריכת קבוצה
1. הובר על קבוצה קיימת
2. לחץ על כפתור העיפרון הכחול
3. שנה שם ל-"סלטים ביתיים משודרגים"
4. שמור
5. ✅ **צפוי:** השם השתנה, לא נוצרה קבוצה חדשה

### בדיקה 3: מחיקת קבוצה ריקה
1. צור קבוצה חדשה (ללא פריטים)
2. הובר עליה ולחץ על פח האשפה
3. אשר במודאל
4. ✅ **צפוי:** הקבוצה נמחקה

### בדיקה 4: ניסיון מחיקת קבוצה עם פריטים
1. הובר על קבוצה עם פריטים
2. לחץ על פח האשפה
3. ✅ **צפוי:** הודעת שגיאה "לא ניתן למחוק קבוצה שיש בה X פריטים"

### בדיקה 5: מחיקת פריט
1. לחץ על כפתור "מחיקה" של פריט
2. ✅ **צפוי:** חלון אישור מופיע
3. אשר
4. ✅ **צפוי:** הפריט נמחק

---

## 🔄 תרשים זרימה

```
┌─────────────────┐
│  לחיצה על +    │
│  בסרגל צד      │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  מודאל קבוצה   │
│  (ריק)          │
└────────┬────────┘
         │
         v
┌─────────────────┐      ┌──────────────┐
│  מילוי שדות    │──NO──│   הודעת     │
│  + שמירה       │      │   שגיאה      │
└────────┬────────┘      └──────────────┘
         │ YES
         v
┌─────────────────┐
│  POST API       │
│  /addon-groups  │
└────────┬────────┘
         │
         v
┌─────────────────┐
│  רענון רשימה   │
│  + סגירת מודאל │
└─────────────────┘
```

---

## 📊 סטטיסטיקות שינויים

| סוג שינוי | מספר |
|-----------|------|
| **Backend Functions** | 2 חדשים (store, delete) |
| **Routes** | 2 חדשים (POST, DELETE) |
| **Frontend Functions** | 4 חדשים |
| **States** | 3 חדשים |
| **UI Components** | 1 מודאל חדש + 3 כפתורים |
| **Validations** | 2 backend + 2 frontend |

---

## 🚀 מה הבא?

### אופציות עתידיות (לא בוצעו):
1. **סידור מחדש (Drag & Drop)** - גרירת קבוצות לשינוי sort_order
2. **העתקת קבוצה** - שכפול קבוצה עם כל הפריטים
3. **העברת פריטים בין קבוצות** - drag & drop פריטים
4. **ארכיון קבוצות** - במקום מחיקה, הסתרה
5. **ייצוא/ייבוא קבוצות** - העברה בין מסעדות

---

## ✅ Checklist סופי

- [x] הוספת קבוצה חדשה עובדת
- [x] עריכת קבוצה קיימת עובדת
- [x] מחיקת קבוצה ריקה עובדת
- [x] מניעת מחיקת קבוצה עם פריטים
- [x] אישור לפני מחיקת פריט
- [x] אישור לפני מחיקת קבוצה
- [x] כפתורים מופיעים רק למנהלים
- [x] אנימציות חלקות
- [x] הודעות שגיאה ברורות
- [x] אין שגיאות קומפילציה

---

**הערה חשובה:** כל השינויים שומרים על תאימות לאחור עם המערכת הקיימת. לא נפגעה לוגיקת ההזמנות.
