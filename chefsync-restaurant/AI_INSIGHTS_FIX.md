# תיקון תובנות AI - Dashboard Insights Fix

## 🐛 הבעיה שתוארה
הסוכן החכם (AI) בדשבורד מייצר מידע שגוי שלא קשור למסעדה:
- מציין מנות שלא קיימות בתפריט (פיצה, המבורגר)
- ממציא נתונים במקום להשתמש במידע אמיתי
- לא מתייחס לנתונים הספציפיים של המסעדה

## ✅ הפתרון שיושם

### 1. הוספת נתונים אמיתיים לקונטקסט
**קובץ:** `backend/app/Http/Controllers/AiController.php`

**לפני:**
```php
$context = [
    'restaurant_name' => $restaurant->name,
    'total_menu_items' => 5,  // רק מספר
    'orders_week' => 10,       // רק מספר
    // ...
];
```

**אחרי:**
```php
$context = [
    'restaurant_name' => $restaurant->name,
    'tenant_id' => $tenantId,
    'menu_items' => [
        ['name' => 'שניצל', 'category' => 'עיקריות', 'price' => 45],
        ['name' => 'סלט קיסר', 'category' => 'סלטים', 'price' => 32],
        // רשימה מלאה של מנות אמיתיות
    ],
    'top_sellers' => [
        ['name' => 'שניצל', 'total_sold' => 35],
        ['name' => 'סלט קיסר', 'total_sold' => 28],
        // מנות שנמכרו בפועל ב-30 יום אחרונים
    ],
    'categories' => ['עיקריות', 'סלטים', 'קינוחים'],
    // ...
];
```

### 2. תיקון הפרומפט - OpenAI Service
**קובץ:** `backend/app/Services/OpenAiService.php`

**לפני:**
```php
$prompt = "נתח נתוני דשבורד...
הזמנות: יום=5, שבוע=20
תפריט: 15 מנות, 4 קטגוריות";
```

**אחרי:**
```php
$systemPrompt = "אתה אנליסט עסקי למסעדה '{$restaurantName}' (tenant_id: {$tenantId}). 
אתה חייב לענות רק על סמך הנתונים האמיתיים של המסעדה הזו. 
אסור לך להמציא מנות או מידע שלא קיים.";

$prompt = "📊 סטטיסטיקות הזמנות...
🍽️ תפריט המסעדה:
- שניצל (עיקריות) - ₪45
- סלט קיסר (סלטים) - ₪32

🏆 המנות הנמכרות ביותר (30 יום):
- שניצל: 35 יחידות
- סלט קיסר: 28 יחידות

**חשוב: השתמש רק במידע האמיתי שסיפקתי. אל תמציא מנות או נתונים!**";
```

### 3. תיקון זהה ל-Copilot Service (מקומי)
**קובץ:** `backend/app/Services/CopilotService.php`

אותם שינויים בדיוק עבור סביבת פיתוח מקומית.

## 🔄 איך לבדוק את התיקון

### 1. נקה מטמון
```bash
cd backend
php artisan cache:clear
```

### 2. רענן את התובנות בדשבורד
1. היכנס לדשבורד Admin
2. גלול לסקשן "תובנות עסקיות (AI)"
3. לחץ על כפתור הרענון 🔄

### 3. בדוק שהתובנות כוללות רק מנות שקיימות
- ה-AI צריך להזכיר **רק** מנות שבאמת קיימות בתפריט שלך
- אם אין מספיק נתונים - יאמר "אין מספיק נתונים" במקום להמציא

## 📊 לוגים לדיבאג
אם עדיין יש בעיה, בדוק:

```bash
tail -f backend/storage/logs/laravel.log | grep "Dashboard Context"
```

תראה את הנתונים המדויקים שנשלחים ל-AI:
```json
{
  "restaurant_name": "מסעדת דוגמה",
  "tenant_id": "pizza-palace",
  "menu_items": [...],
  "top_sellers": [...]
}
```

## 🎯 תוצאות צפויות
אחרי התיקון, ה-AI יענה משהו כמו:
- ✅ "שניצל וסלט קיסר מובילים את המכירות"
- ✅ "אין מספיק נתונים לניתוח זמני שיא"
- ❌ לא: "פיצה והמבורגר הכי נמכרות" (אם אין לך כאלה!)

## 🔐 אבטחה
- הוספנו `tenant_id` לפרומפט כדי ש-AI יבין שהוא עובד עם מסעדה ספציפית
- ה-Global Scopes של Laravel מבטיחים שנתונים נשלפים רק מהטנאנט הנכון
- המטמון כולל את ה-tenant_id במפתח

## 📝 הערות
- המטמון נשמר ל-24 שעות
- אפשר לכפות רענון עם כפתור 🔄
- אם יש פחות מ-5 הזמנות בחודש - מוצג מסר מיוחד
